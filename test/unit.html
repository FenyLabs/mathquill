<!DOCTYPE html>

<html>
  <head>
    <!-- allow fancy checkmarks to show up -->
    <meta charset="UTF-8">

    <!-- complain about uncaught errors -->
    <script type="text/javascript">
    window.onerror = function() {
      document.documentElement.style.background = 'red';
    };
    </script>

    <!-- better living through jQuery -->
    <script type="text/javascript" src="support/jquery-1.5.2.js"></script>

    <!-- mocha test framework -->
    <script type="text/javascript" src="../node_modules/mocha/mocha.js"></script>
    <link rel="stylesheet" type="text/css" href="../node_modules/mocha/mocha.css" />

    <!-- home-grown assertions -->
    <script src="support/assert.js" type="text/javascript"></script>

    <!-- configure mocha and chai -->
    <script type="text/javascript">
      var json = true; //location.search.indexOf('json') >= 0;
      var listTests = location.search.indexOf('listTests') >= 0;

      mocha.setup({
        ui: 'tdd',
        reporter: 'html'
      });
    </script>

    <!-- include the library with the tests inlined -->
    <script id="mathquill" type="text/javascript" src="../build/mathquill.test.js"
      onerror="alert('couldn\'t find `build/mathquill.test.js`. Please run `make test` before opening this file.')">
    </script>

    <!-- include MathQuill-basic -->
    <link rel="stylesheet" type="text/css" href="../build/mathquill.css" />
    <script type="text/javascript" src="../build/mathquill-basic.js"></script>
    <script type="text/javascript">
      MQBasic = MathQuill.noConflict().getInterface(MathQuill.getInterface.MAX);
      MQ = MathQuill.getInterface(MathQuill.getInterface.MAX);
    </script>

  </head>

  <body>
    <h1>Unit Tests</h1>
    <div id="mocha"></div>
    <div id="mock"></div>
    <div id="qunit"></div>

    <script type="text/javascript">
      teardown(function() { $('#mock').empty(); });
      var startTime = Date.now();
      var moduleResults = [];
      var currentSuite;
      var runner = mocha.run();

      runner.on('suite', function(suite) {
        var suiteResults = {};
        suiteResults.name = suite.title;
        suiteResults.time = Date.now() - startTime;
        suiteResults.assertions = [];
        currentSuite = suiteResults;
        if (listTests) {
          currentSuite.assertions.push({
            "elapsedTime": 0,
            "timestamp": 0,
            "result": true,
            "message": "okay"
          });
        }
      });

      runner.on('suite end', function() {
        var lastPushedSuite = moduleResults[moduleResults.length - 1];
        if (!lastPushedSuite || lastPushedSuite.name !== currentSuite.name) {
          moduleResults.push(currentSuite);
        }
      });

      runner.on('pass', function(test) {
        if (!listTests) {
          var elapsedTime = Date.now() - startTime;
          var timestamp = elapsedTime - currentSuite.time;
          currentSuite.assertions.push({
            "elapsedTime": elapsedTime,
            "timestamp": timestamp,
            "result": true,
            "message": test.title
          });
        }
      });

      runner.on('fail', function(test, err) {
        if (!listTests) {
          var elapsedTime = Date.now() - startTime;
          var timestamp = elapsedTime - currentSuite.time;
          currentSuite.assertions.push({
            "elapsedTime": elapsedTime,
            "timestamp": timestamp,
            "result": false,
            "message": err.message,
            "stacktrace": err.stack,
            "expected": true,
            "actual": false
          });
        }
      });

      runner.on('end', function() {
        if (json || listTests) {
          var testResults = {
            modules: { "mathquill": moduleResults },
            passes: runner.stats.passes,
            failures: runner.stats.failures,
            skips: 0
          };
          window.testResultsString = JSON.stringify(testResults, null, 2);
        }
      });
    </script>
  </body>
</html>
